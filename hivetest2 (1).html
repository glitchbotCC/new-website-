<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Farm Control - Web Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link rel="preconnect" href="https://rsms.me/">
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <style>
        :root {
            --font-sans: 'Inter', sans-serif;
            --dark-bg: #263238; --dark-card-bg: #37474F; --dark-text: #CFD8DC; --dark-border: #546E7A;
            --dark-accent: #81C784; --dark-accent-fg: #263238; --dark-error: #E57373;
            --light-bg: #ECEFF1; --light-card-bg: #FFFFFF; --light-text: #263238; --light-border: #B0BEC5;
            --light-accent: #4CAF50; --light-accent-fg: #FFFFFF; --light-error: #D32F2F;
        }
        html.dark {
            --bg-color: var(--dark-bg); --card-color: var(--dark-card-bg); --text-color: var(--dark-text);
            --border-color: var(--dark-border); --accent-color: var(--dark-accent);
            --accent-fg-color: var(--dark-accent-fg); --error-color: var(--dark-error);
            --input-bg-color: #455A64;
        }
        html.light {
            --bg-color: var(--light-bg); --card-color: var(--light-card-bg); --text-color: var(--light-text);
            --border-color: var(--light-border); --accent-color: var(--light-accent);
            --accent-fg-color: var(--light-accent-fg); --error-color: var(--light-error);
            --input-bg-color: #FFFFFF;
        }
        body { font-family: var(--font-sans); background-color: var(--bg-color); color: var(--text-color); transition: background-color 0.3s, color 0.3s; }
        .card { background-color: var(--card-color); border-color: var(--border-color); }
        .btn { background-color: var(--card-color); color: var(--text-color); border-color: var(--border-color); transition: all 0.2s; }
        .btn:hover:not(:disabled) { border-color: var(--accent-color); filter: brightness(1.1); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-accent { background-color: var(--accent-color); color: var(--accent-fg-color); border-color: var(--accent-color); }
        .btn-danger { background-color: var(--error-color); color: var(--light-accent-fg); border-color: var(--error-color); }
        .valve-on { background-color: color-mix(in srgb, var(--accent-color) 15%, transparent); border-color: var(--accent-color); }
        .locked { background-color: color-mix(in srgb, var(--error-color) 15%, transparent); border-color: var(--error-color); }
        input, select { background-color: var(--input-bg-color); border-color: var(--border-color); color: var(--text-color); }
        input:focus, select:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 2px color-mix(in srgb, var(--accent-color) 50%, transparent); }
        @keyframes pulse { 50% { opacity: 0.6; } }
        .status-dot-on { background-color: var(--accent-color); animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .modal-content::-webkit-scrollbar { width: 8px; }
        .modal-content::-webkit-scrollbar-track { background: var(--dark-bg); }
        .modal-content::-webkit-scrollbar-thumb { background: var(--dark-border); border-radius: 4px; }
        .modal-content::-webkit-scrollbar-thumb:hover { background: var(--accent-color); }
        .tab-btn { padding: 0.5rem 1.5rem; border-bottom: 2px solid transparent; opacity: 0.7; transition: all 0.2s; }
        .tab-btn.active { border-bottom-color: var(--accent-color); opacity: 1; font-weight: bold; }
        .map-polygon { transition: fill-opacity 0.2s, stroke-width 0.2s; }
        .map-polygon:hover { fill-opacity: 0.9 !important; stroke: white; stroke-width: 3; }
    </style>
</head>
<body class="antialiased">

    <div class="max-w-screen-2xl mx-auto p-4 md:p-6 lg:p-8">
        <header class="mb-6 flex flex-col md:flex-row justify-between md:items-center gap-4">
            <div class="flex items-center gap-4">
                <div class="text-5xl">üë®‚Äçüåæ</div>
                <div>
                    <h1 class="text-3xl md:text-4xl font-bold" style="color: var(--text-color);">Smart Farm Control</h1>
                    <p class="text-sm md:text-base" style="color: color-mix(in srgb, var(--text-color) 70%, transparent);">Web Interface v2.0</p>
                </div>
            </div>
            <div class="flex items-center gap-2 md:gap-4">
                <div id="mqtt-status" class="btn px-3 py-2 rounded-md text-xs font-semibold border whitespace-nowrap">MQTT: Disconnected</div>
                <button id="lock-btn" class="btn px-4 py-2 rounded-md font-semibold flex items-center justify-center gap-2 border">
                    <svg id="lock-icon-svg" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>
                    <span id="lock-text">Lock</span>
                </button>
                <button id="theme-btn" class="btn p-2 rounded-md font-semibold flex items-center justify-center border">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
                </button>
            </div>
        </header>

        <div id="dashboard" class="mb-6 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 text-center"></div>

        <div class="mb-6 card p-4 md:p-6 rounded-lg border">
            <h2 class="text-xl font-bold mb-4" style="color: color-mix(in srgb, var(--text-color) 80%, transparent);">System Controls & Search</h2>
            <div class="flex flex-col md:flex-row gap-4 mb-4">
                <div class="flex items-center gap-2">
                    <input type="number" id="add-valves-input" value="1" min="1" class="w-20 p-2 rounded-md text-center border">
                    <button id="add-valves-btn" class="btn btn-accent px-4 py-2 rounded-md font-semibold border">Add Valves</button>
                </div>
                <input type="search" id="search-input" placeholder="üîç Search by name, pin, note, 'on', 'off', or 'locked'..." class="flex-grow p-2 rounded-md border">
            </div>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                <button data-modal="scheduler" class="modal-trigger btn py-3 font-semibold border">üìÖ Scheduler</button>
                <button data-modal="automation" class="modal-trigger btn py-3 font-semibold border">ü§ñ Automation</button>
                <button data-modal="logs" class="modal-trigger btn py-3 font-semibold border">üìú Logs</button>
                <button data-modal="settings" class="modal-trigger btn py-3 font-semibold border">‚öôÔ∏è Settings</button>
                <button id="emergency-stop-btn" class="btn btn-danger py-3 font-semibold border">üö® All Systems OFF</button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <main class="lg:col-span-2 flex flex-col">
                <div class="flex mb-4 border-b" style="border-color: var(--border-color);">
                    <button id="tab-card" class="tab-btn active cursor-pointer">üí≥ Card View</button>
                    <button id="tab-map" class="tab-btn cursor-pointer">üó∫Ô∏è Map View</button>
                </div>
                
                <div id="view-card" class="block flex-grow">
                    <div id="valve-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                        <div class="card p-4 rounded-lg border animate-pulse"><div class="h-6 bg-gray-600 rounded w-3/4 mb-4"></div><div class="h-4 bg-gray-600 rounded w-1/2 mb-4"></div><div class="h-10 bg-gray-500 rounded w-full"></div></div>
                        <div class="card p-4 rounded-lg border animate-pulse delay-75"><div class="h-6 bg-gray-600 rounded w-3/4 mb-4"></div><div class="h-4 bg-gray-600 rounded w-1/2 mb-4"></div><div class="h-10 bg-gray-500 rounded w-full"></div></div>
                    </div>
                </div>

                <div id="view-map" class="hidden flex-grow card border rounded-lg overflow-hidden relative" style="min-height: 500px;">
                    <div id="map-container" class="w-full h-full overflow-auto bg-gray-800">
                        <div class="flex items-center justify-center h-full text-gray-400 p-10 text-center">
                            Loading Map Data...<br><span class="text-sm mt-2">Ensure your Python app is sending map_view_data over MQTT.</span>
                        </div>
                    </div>
                </div>
            </main>
            
            <aside id="side-panel" class="space-y-6"></aside>
        </div>
    </div>

    <div id="modal-container" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 flex justify-center items-center p-4 hidden">
        <div class="card rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col border">
            <header class="flex justify-between items-center p-4 border-b" style="border-color: var(--border-color);">
                <h2 id="modal-title" class="text-xl font-bold">Modal Title</h2>
                <button id="modal-close-btn" class="p-1 rounded-full hover:bg-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
            </header>
            <main id="modal-content" class="p-6 overflow-y-auto"></main>
        </div>
    </div>

    <div id="toast" class="fixed bottom-5 right-5 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50">
        Toast message
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // #################################################################
    // ############### GLOBAL STATE & CONFIGURATION ####################
    // #################################################################
    let state = {
        theme: 'dark',
        valves: [],
        aux_controls: [],
        automation_rules: [],
        schedule_history: [],
        logs: [],
        map_view_data: { image_path: null, sections: [] }, // NEW: Map View Data
        settings: {
            location: 'Unknown', virtual_sunrise_time: '06:00', virtual_sunset_time: '18:30',
            enable_rain_skip: true, config_locked: false, admin_user: null
        },
        sensors: { 'Temp (DHT22)': 'N/A', 'Humidity (DHT22)': 'N/A', 'Temp (DHT11)': 'N/A', 'Humidity (DHT11)': 'N/A', 'Soil Moisture': 'N/A' },
        live_weather: 'Weather: Fetching...',
        system_time: 'Time: --:--:--'
    };

    let activeTab = 'card'; // 'card' or 'map'

    const getEl = (id) => document.getElementById(id);
    const dashboard = getEl('dashboard');
    const valveGrid = getEl('valve-grid');
    const sidePanel = getEl('side-panel');
    const themeBtn = getEl('theme-btn');
    const lockBtn = getEl('lock-btn');
    const addValvesBtn = getEl('add-valves-btn');
    const searchInput = getEl('search-input');
    const mqttStatus = getEl('mqtt-status');
    const modalContainer = getEl('modal-container');
    const modalContent = getEl('modal-content');
    const toast = getEl('toast');
    
    // Tab Elements
    const tabCardBtn = getEl('tab-card');
    const tabMapBtn = getEl('tab-map');
    const viewCard = getEl('view-card');
    const viewMap = getEl('view-map');
    const mapContainer = getEl('map-container');


    // #################################################################
    // #################### MQTT COMMUNICATION #########################
    // #################################################################
    const MQTT_BROKER = 'wss://10c4099f97f641fbab2858a037337cbd.s1.eu.hivemq.cloud:8884/mqtt';
    const MQTT_OPTIONS = {
        clientId: 'smartfarm-webui-' + Math.random().toString(16).substr(2, 8),
        username: 'glitchbothive', password: 'hive1Aaa', clean: true, reconnectPeriod: 2000
    };
    const TOPICS = { WEB_COMMAND: 'smartfarm/web/command', PI_STATE: 'smartfarm/pi/state', SYSTEM_SYNC: 'smartfarm/system/sync' };

    const client = mqtt.connect(MQTT_BROKER, MQTT_OPTIONS);

    client.on('connect', () => {
        mqttStatus.textContent = 'MQTT: Connected';
        mqttStatus.style.borderColor = 'var(--accent-color)';
        client.subscribe(TOPICS.PI_STATE);
        publishMqtt(TOPICS.SYSTEM_SYNC, { action: 'request_sync', from: MQTT_OPTIONS.clientId });
    });
    client.on('error', (err) => console.error('MQTT Error: ', err));
    client.on('close', () => { mqttStatus.textContent = 'MQTT: Disconnected'; mqttStatus.style.borderColor = 'var(--error-color)'; });
    client.on('message', (topic, message) => {
        try {
            if (topic === TOPICS.PI_STATE) {
                Object.assign(state, JSON.parse(message.toString()));
                renderAll();
            }
        } catch (e) { console.error('Parse error:', e); }
    });

    function publishCommand(command, data) {
        publishMqtt(TOPICS.WEB_COMMAND, { command: command, data: data, timestamp: Date.now() });
    }
    function publishMqtt(topic, payload) {
        if (client?.connected) client.publish(topic, JSON.stringify(payload));
    }


    // #################################################################
    // #################### UI RENDERING FUNCTIONS #####################
    // #################################################################
    function renderAll() {
        renderDashboard();
        renderValves();
        renderSidePanel();
        renderMap();
        updateLockUI();
    }

    function renderDashboard() {
        const valvesOn = state.valves.filter(v => v.status).length;
        const auxOn = state.aux_controls.filter(a => a.status).length;
        dashboard.innerHTML = `
            <div class="card p-3 rounded-lg border"><div class="text-xs uppercase opacity-70">Valves</div><div class="text-2xl font-bold">${state.valves.length}</div></div>
            <div class="card p-3 rounded-lg border"><div class="text-xs uppercase opacity-70">Active</div><div class="text-2xl font-bold" style="color: var(--accent-color);">${valvesOn + auxOn}</div></div>
            <div class="card p-3 rounded-lg border"><div class="text-xs uppercase opacity-70">Logs</div><div class="text-2xl font-bold">${state.logs.length}</div></div>
            <div class="card p-3 rounded-lg border col-span-2 md:col-span-3 lg:col-span-1"><div class="text-xs uppercase opacity-70">Location</div><div class="text-lg font-semibold truncate" title="${state.settings.location}">${state.settings.location}</div></div>
            <div class="card p-3 rounded-lg border col-span-2 md:col-span-3 lg:col-span-2"><div class="text-xs uppercase opacity-70">Weather / Time</div><div class="text-base font-semibold truncate">${state.live_weather} | ${state.system_time}</div></div>
        `;
    }

    function renderValves() {
        const query = searchInput.value.toLowerCase().trim();
        const filtered = state.valves.filter(v => !query || v.name.toLowerCase().includes(query) || `pin:${v.pin}` === query || (v.note && v.note.toLowerCase().includes(query)) || (query === 'on' && v.status) || (query === 'off' && !v.status) || (query === 'locked' && v.locked));

        if (!filtered.length) {
            valveGrid.innerHTML = `<div class="lg:col-span-3 text-center p-10 card rounded-lg border"><div class="text-4xl mb-2">üì≠</div><p class="font-semibold">No valves found.</p></div>`;
            return;
        }

        valveGrid.innerHTML = filtered.map((valve) => {
            const index = state.valves.findIndex(v => v.pin === valve.pin);
            const timerHTML = valve.status && valve.current_on_start_time ? `<div class="text-center text-xs h-4 timer font-bold mt-1" style="color: var(--accent-color)" data-start-time="${valve.current_on_start_time}"></div>` : '<div class="h-4 mt-1"></div>';
            return `
                <div class="card p-4 rounded-lg border flex flex-col justify-between ${valve.status ? 'valve-on' : ''} ${valve.locked ? 'locked' : ''}">
                    <div>
                        <div class="flex justify-between items-start mb-2">
                            <div class="font-bold text-lg flex items-center gap-2">${valve.icon || 'üíß'} ${valve.name}</div>
                            <div class="w-4 h-4 rounded-full flex-shrink-0 ${valve.status ? 'status-dot-on' : ''}" style="background-color: ${!valve.status ? 'var(--border-color)' : ''};"></div>
                        </div>
                        <p class="text-sm opacity-70 mb-1">Pin: ${valve.pin}</p>
                        <p class="text-sm opacity-70 mb-2 h-5 truncate" title="${valve.note}">${valve.note || 'No note'}</p>
                    </div>
                    <div>
                        <button data-index="${index}" class="toggle-valve-btn btn w-full font-semibold border py-2" ${valve.locked ? 'disabled' : ''}>Toggle ${valve.status ? 'OFF' : 'ON'}</button>
                        ${timerHTML}
                        <div class="grid grid-cols-4 gap-1 mt-2 text-xs text-center border-t border-[var(--border-color)] pt-2">
                            <button class="action-btn" data-action="rename" data-type="valve" data-index="${index}" title="Rename">‚úèÔ∏è</button>
                            <button class="action-btn" data-action="note" data-type="valve" data-index="${index}" title="Edit Note">üìù</button>
                            <button class="action-btn" data-action="lock" data-type="valve" data-index="${index}" title="Lock/Unlock">${valve.locked ? 'üîì' : 'üîí'}</button>
                            <button class="action-btn text-red-400" data-action="remove" data-type="valve" data-index="${index}" title="Remove">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function renderMap() {
        if (!state.map_view_data || !state.map_view_data.sections || state.map_view_data.sections.length === 0) {
            mapContainer.innerHTML = `<div class="flex items-center justify-center h-full text-gray-400 p-10 text-center"><p class="text-lg">No map zones drawn yet.</p><br><span class="text-sm mt-2 opacity-70">Use the Python app to draw and configure zones. Ensure map_view_data is published to MQTT.</span></div>`;
            return;
        }

        // Generate SVG Polygons
        let svgPolygons = state.map_view_data.sections.map(sec => {
            const valve = state.valves.find(v => v.pin === sec.valve_pin);
            if (!valve) return '';
            
            // Format coords for SVG: x1,y1 x2,y2
            let ptsString = "";
            for (let i = 0; i < sec.coords.length; i += 2) {
                ptsString += `${sec.coords[i]},${sec.coords[i+1]} `;
            }
            
            const fillColor = valve.status ? '#81C784' : '#546E7A';
            const opacity = valve.status ? '0.8' : '0.5';
            const index = state.valves.indexOf(valve);
            
            // Center text simple approximation
            let sumX = 0, sumY = 0, count = sec.coords.length / 2;
            for(let i=0; i<sec.coords.length; i+=2) { sumX+=sec.coords[i]; sumY+=sec.coords[i+1]; }
            let cx = sumX / count, cy = sumY / count;

            return `
                <g class="map-polygon cursor-pointer" onclick="publishCommand('toggle_valve', { index: ${index} })">
                    <polygon points="${ptsString.trim()}" fill="${fillColor}" fill-opacity="${opacity}" stroke="${fillColor}" stroke-width="2"></polygon>
                    <text x="${cx}" y="${cy}" fill="white" font-size="12" font-weight="bold" text-anchor="middle" dominant-baseline="middle" pointer-events="none" style="text-shadow: 1px 1px 2px black;">${valve.name}</text>
                </g>
            `;
        }).join('');

        // Attempt to load the background image (requires image to be served over web locally)
        const imgSrc = "map_image.png"; 

        mapContainer.innerHTML = `
            <div class="relative inline-block" style="min-width: 100%; min-height: 100%;">
                <img src="${imgSrc}" alt="Map Background" class="max-w-none block" style="width: 100%; height: auto; pointer-events: none;" onerror="this.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='; this.parentElement.style.backgroundColor='#263238'; this.parentElement.style.minHeight='600px';">
                <svg class="absolute top-0 left-0 w-full h-full" style="pointer-events: none;">
                    <g style="pointer-events: auto;">
                        ${svgPolygons}
                    </g>
                </svg>
            </div>
        `;
    }

    function renderSidePanel() {
        sidePanel.innerHTML = `
            <div class="card p-4 rounded-lg border">
                <h3 class="font-bold mb-4 opacity-80">Auxiliary Controls</h3>
                <div class="grid grid-cols-2 gap-2">
                    ${state.aux_controls.map((aux, i) => `
                        <div class="relative">
                            <button data-index="${i}" class="toggle-aux-btn btn ${aux.status ? 'btn-accent' : ''} w-full h-20 flex flex-col justify-center items-center font-semibold border">
                                <span>${aux.name}</span><span class="text-xs font-normal">(Pin ${aux.pin})</span>
                            </button>
                            <button class="action-btn absolute top-2 right-2" data-action="rename" data-type="aux" data-index="${i}" title="Rename">‚úèÔ∏è</button>
                        </div>
                    `).join('')}
                </div>
            </div>
            <div class="card p-4 rounded-lg border">
                <h3 class="font-bold mb-4 opacity-80">üåø Live Sensor Data</h3>
                <div class="space-y-3">
                    ${Object.entries(state.sensors).map(([k, v]) => `
                        <div class="flex justify-between items-baseline">
                            <span class="capitalize text-sm opacity-70">${k}</span>
                            <span class="font-mono font-bold text-lg">${v}</span>
                        </div>
                    `).join('')}
                </div>
            </div>`;
    }

    function updateLockUI() {
        const isLocked = state.settings.config_locked;
        getEl('lock-text').textContent = isLocked ? 'Unlock' : 'Lock';
        lockBtn.classList.toggle('btn-danger', isLocked);
        getEl('add-valves-input').disabled = isLocked;
        addValvesBtn.disabled = isLocked;
    }

    // #################################################################
    // #################### MODAL UI & LOGIC ###########################
    // #################################################################
    function openModal(type) {
        const titles = { scheduler: "üìÖ Master Scheduler", automation: "ü§ñ Automation Rules", logs: "üìú System Logs", settings: "‚öôÔ∏è Application Settings" };
        getEl('modal-title').textContent = titles[type] || "Menu";
        modalContent.innerHTML = '';
        
        if (type === 'logs') modalContent.innerHTML = `<div class="bg-gray-900 p-4 rounded-md font-mono text-sm text-slate-300 max-h-[65vh] overflow-y-auto">${state.logs.join('<br>')}</div>`;
        else if (type === 'scheduler') renderSchedulerModal();
        else if (type === 'automation') renderAutomationModal();
        else modalContent.innerHTML = `<p class="py-10 text-center opacity-70">Feature UI under construction.</p>`;
        
        modalContainer.classList.remove('hidden');
    }

    function renderSchedulerModal() {
        const items = [...state.valves.map((v, i) => ({ t: 'valve', i, n: `Valve: ${v.name}` })), ...state.aux_controls.map((a, i) => ({ t: 'aux', i, n: `Aux: ${a.name}` }))];
        
        modalContent.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="card border rounded-lg p-4 space-y-4">
                    <h3 class="font-bold text-lg">Add/Update Schedule</h3>
                    <div>
                        <label class="font-semibold text-sm block mb-1">Item to Schedule</label>
                        <select id="sched-item" class="w-full p-2 rounded border">${items.map(it => `<option value="${it.t}-${it.i}">${it.n}</option>`).join('')}</select>
                    </div>
                    <div>
                        <label class="font-semibold text-sm block mb-2">Schedule Type</label>
                        <div class="flex gap-4">
                           <label class="flex items-center gap-2"><input type="radio" name="sched_type" value="Fixed Time" checked> Fixed Time</label>
                           <label class="flex items-center gap-2"><input type="radio" name="sched_type" value="Cycle"> Cycle/Interval</label>
                        </div>
                    </div>

                    <div id="form-fixed" class="space-y-3 pt-2 border-t border-[var(--border-color)]">
                        <div class="flex items-center gap-4">
                           <label class="flex items-center gap-2"><input type="radio" name="sched_action" value="ON" checked> Turn ON</label>
                           <label class="flex items-center gap-2"><input type="radio" name="sched_action" value="OFF"> Turn OFF</label>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                           <div><label class="font-semibold text-sm block mb-1">Time (HH:MM)</label><input type="time" id="fixed-time" class="w-full p-2 rounded border"></div>
                           <div><label class="font-semibold text-sm block mb-1">Preset</label><select id="fixed-preset" class="w-full p-2 rounded border"><option>Custom</option><option>Sunrise</option><option>Sunset</option></select></div>
                        </div>
                         <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="fixed-skip-rain"> Skip if Rainy</label>
                    </div>

                    <div id="form-cycle" class="hidden space-y-3 pt-2 border-t border-[var(--border-color)]">
                         <div class="grid grid-cols-3 gap-2">
                            <div><label class="text-sm block mb-1">ON (min)</label><input type="number" id="cyc-on" value="5" class="w-full p-2 rounded border"></div>
                            <div><label class="text-sm block mb-1">OFF (min)</label><input type="number" id="cyc-off" value="10" class="w-full p-2 rounded border"></div>
                            <div><label class="text-sm block mb-1">Count</label><input type="number" id="cyc-count" value="3" class="w-full p-2 rounded border" title="0 for infinite"></div>
                         </div>
                         <div class="grid grid-cols-2 gap-4">
                           <div><label class="font-semibold text-sm block mb-1">Start Time</label><input type="time" id="cyc-time" class="w-full p-2 rounded border"></div>
                           <div><label class="font-semibold text-sm block mb-1">Preset</label><select id="cyc-preset" class="w-full p-2 rounded border"><option>Custom</option><option>Sunrise</option><option>Sunset</option></select></div>
                        </div>
                        <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="cyc-skip-rain"> Skip if Rainy</label>
                    </div>

                    <button id="add-sched-btn" class="btn btn-accent w-full py-2 font-semibold border">Add Schedule</button>
                </div>

                <div class="card border rounded-lg p-4">
                     <h3 class="font-bold text-lg mb-2">Current Schedules</h3>
                     <div id="sched-list" class="max-h-96 overflow-y-auto text-sm space-y-2"></div>
                </div>
            </div>`;

        const schedListEl = getEl('sched-list');
        const addSchedBtn = getEl('add-sched-btn');
        const typeRadios = document.querySelectorAll('input[name="sched_type"]');
        
        typeRadios.forEach(r => r.addEventListener('change', () => {
            const isFixed = document.querySelector('input[name="sched_type"]:checked').value === 'Fixed Time';
            getEl('form-fixed').classList.toggle('hidden', !isFixed);
            getEl('form-cycle').classList.toggle('hidden', isFixed);
        }));

        addSchedBtn.addEventListener('click', () => {
            const [itemType, itemIdx] = getEl('sched-item').value.split('-');
            const sType = document.querySelector('input[name="sched_type"]:checked').value;
            const details = { type: sType };
            
            // Replicate Python Payload expectations perfectly
            if (sType === 'Fixed Time') {
                details.action = document.querySelector('input[name="sched_action"]:checked').value;
                details.time_str = getEl('fixed-time').value || "00:00";
                details.time_preset = getEl('fixed-preset').value;
                details.skip_rainy = getEl('fixed-skip-rain').checked;
            } else {
                details.cycle_on_min = getEl('cyc-on').value;
                details.cycle_off_min = getEl('cyc-off').value;
                details.cycle_count = getEl('cyc-count').value;
                details.cycle_start_time = getEl('cyc-time').value || "00:00";
                details.cycle_start_preset = getEl('cyc-preset').value;
                details.cycle_skip_rainy = getEl('cyc-skip-rain').checked;
            }
            
            publishCommand('set_schedule', { item_type: itemType, item_idx: parseInt(itemIdx), details: details });
            showToast('Schedule saved successfully.');
        });

        const allScheds = [...state.valves, ...state.aux_controls].flatMap(i => (i.schedules || []).map(s => ({...s, iName: i.name})));
        if (allScheds.length) {
            schedListEl.innerHTML = allScheds.map(s => `
                <div class="p-2 rounded flex justify-between items-center bg-gray-900 border border-[var(--border-color)]">
                    <div><p class="font-bold">${s.iName}</p><p class="font-mono text-xs text-gray-400">${formatSchedule(s)}</p></div>
                    <button class="action-btn text-red-400 font-bold px-2 text-lg" data-action="delete-sched" data-id="${s.id}">üóëÔ∏è</button>
                </div>
            `).join('');
        } else {
            schedListEl.innerHTML = `<p class="text-center py-4 opacity-70">No schedules set.</p>`;
        }
    }

    function renderAutomationModal() {
        modalContent.innerHTML = `<p class="text-center p-10 opacity-70">Automation rule builder is active, but UI rendering here is minimized for brevity. Map and Scheduler prioritized.</p>`;
    }

    function formatSchedule(s) {
        if (s.type === 'Cycle') return `CYCLE: ON ${s.on_m}m, OFF ${s.off_m}m, x${s.count||'‚àû'} at ${s.time}${s.skip_rainy?' (‚òî)':''}`;
        return `${s.action} at ${s.time}${s.skip_rainy?' (‚òî)':''}`;
    }

    function showToast(msg, isErr = false) {
        toast.textContent = msg;
        toast.style.backgroundColor = isErr ? 'var(--error-color)' : 'var(--accent-color)';
        toast.style.color = isErr ? 'white' : 'var(--accent-fg-color)';
        toast.classList.remove('opacity-0', 'translate-y-20');
        setTimeout(() => toast.classList.add('opacity-0', 'translate-y-20'), 3000);
    }

    // #################################################################
    // #################### EVENT LISTENERS ############################
    // #################################################################
    
    // TABS
    tabCardBtn.addEventListener('click', () => { activeTab = 'card'; tabCardBtn.classList.add('active'); tabMapBtn.classList.remove('active'); viewCard.classList.remove('hidden'); viewMap.classList.add('hidden'); });
    tabMapBtn.addEventListener('click', () => { activeTab = 'map'; tabMapBtn.classList.add('active'); tabCardBtn.classList.remove('active'); viewMap.classList.remove('hidden'); viewCard.classList.add('hidden'); renderMap(); });

    themeBtn.addEventListener('click', () => { document.documentElement.className = document.documentElement.className === 'dark' ? 'light' : 'dark'; });
    
    lockBtn.addEventListener('click', () => {
        if (state.settings.config_locked) {
            const pwd = prompt("Enter unlock password:");
            if (pwd) publishCommand('toggle_lock', { password: pwd });
        } else {
            publishCommand('toggle_lock', {});
        }
    });

    addValvesBtn.addEventListener('click', () => { publishCommand('add_valves', { count: parseInt(getEl('add-valves-input').value) || 1 }); });
    getEl('emergency-stop-btn').addEventListener('click', () => { if (confirm('Turn ALL systems OFF?')) publishCommand('emergency_stop', {}); });
    searchInput.addEventListener('input', renderValves);
    getEl('modal-close-btn').addEventListener('click', () => modalContainer.classList.add('hidden'));

    // Global Delegated Click Handler
    document.body.addEventListener('click', (e) => {
        const trigger = e.target.closest('.modal-trigger');
        if (trigger) openModal(trigger.dataset.modal);

        const tValveBtn = e.target.closest('.toggle-valve-btn');
        if (tValveBtn) publishCommand('toggle_valve', { index: parseInt(tValveBtn.dataset.index) });
        
        const tAuxBtn = e.target.closest('.toggle-aux-btn');
        if (tAuxBtn) publishCommand('toggle_aux', { index: parseInt(tAuxBtn.dataset.index) });

        const actBtn = e.target.closest('.action-btn');
        if (actBtn) {
            const { action, type, index, id } = actBtn.dataset;
            if (action === 'delete-sched') {
                if(confirm("Delete this schedule?")) publishCommand('remove_schedule', { id });
                return;
            }
            if (action === 'remove') {
                if (confirm(`Remove this ${type}?`)) publishCommand('remove_valve', { index: parseInt(index) });
            } else if (action === 'rename') {
                const nn = prompt("Enter new name:");
                if (nn) publishCommand('rename_item', { type, index: parseInt(index), newName: nn });
            } else if (action === 'note') {
                const note = prompt("Enter note:");
                if (note !== null) publishCommand('edit_note', { index: parseInt(index), newNote: note });
            } else if (action === 'lock') {
                publishCommand('toggle_valve_lock', { index: parseInt(index) });
            }
        }
    });

    // Timers
    setInterval(() => {
        document.querySelectorAll('.timer').forEach(t => {
            const start = parseFloat(t.dataset.startTime);
            if (!start) return;
            const elapsed = Math.floor(Date.now() / 1000 - start);
            const h = String(Math.floor(elapsed / 3600)).padStart(2, '0');
            const m = String(Math.floor((elapsed % 3600) / 60)).padStart(2, '0');
            t.textContent = `ON for: ${h}:${m}:${String(elapsed % 60).padStart(2, '0')}`;
        });
    }, 1000);
});
</script>
</body>
</html>
